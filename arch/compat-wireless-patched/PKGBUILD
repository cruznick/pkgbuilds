# Maintainer:  hokasch <hokasch at operamail dot com>
# Contributor: Dennis Brendel <buddabrod at gmail dot com>
# Contributor: Mathias Buren <mathias.buren at gmail dot com>
# Patched Version Contributor: Benjamin Mtz (Cruznick) <cruznick at archlinux dot us>

pkgname=compat-wireless-patched
srcname=compat-wireless
pkgver=2.6.36
pkgrel=4
pkgdesc='compat wireless driver patched for fixing issues with "fixed-channel -1" and mac80211 patch from aircrack(stable)'
arch=('i686' 'x86_64')
url='http://wireless.kernel.org/en/users/Download/stable/'
license=('GPL')
depends=('kernel26')
makedepends=('linux-api-headers' 'kernel26-headers')
install=compat-wireless-patched.install
source=(http://www.orbit-lab.org/kernel/compat-wireless-2.6-stable/v$pkgver/$srcname-$pkgver-$pkgrel.tar.bz2 'mac80211_2.6.32.2-wl_frag+ack_radiotap.patch' 'channel-negative-one-maxim.patch')
sha1sums=('7b6e4e8314008cef7c6b132fd6925f1c2660f8d2'
	  '2af535ba85f6d7d5f51601d18e45171d8bb3c9f4' 
          'a611acdd7994b07b0b39417ef7a5a6ffc866a733')


	###--Drivers-options--##
	# Supported 802.11 drivers:
	#	ath5k
	#	ath9k
	#	ath9k_htc
	#	ar9170
	#	b43
	#	zd1211rw
	#	rt2x00

	# Supported Ethernet drivers:
	#	atl1
	#	atl2
	#	atl1e
	#	atl1c

	# Supported groups of drivers:
	# atheros <  ath5k ath9k ar9170 zd1211rw >
	# ath <  ath5k ath9k ar9170 >
	# intel <  iwl3945 iwlagn ipw2100 ipw2200 >
	# iwlwifi <  iwl3945 iwlagn >
	# rtl818x <  rtl8180 rtl8187 >
	# wl12xx <  wl1251 (SPI and SDIO) wl1271 >


build() {


  cd "$srcdir/$srcname-$pkgver-$pkgrel"
  
    msg "Patching ..." 

  patch -p1 -i ${srcdir}/mac80211_2.6.32.2-wl_frag+ack_radiotap.patch || return 1 
  patch -p1 -i ${srcdir}/channel-negative-one-maxim.patch || return 1 

   msg "Please select your driver:"
   msg "###--Drivers-options--##"
   msg " Supported 802.11 drivers:"
   msg "	ath5k"
   msg "	ath9k"
   msg "	ath9k_htc"
   msg "	ar9170"
   msg "	b43"
   msg "	zd1211rw"
   msg "	rt2x00"
   msg " Supported Ethernet drivers:"
   msg "	atl1"
   msg "	atl2"
   msg "	atl1e"
   msg "	atl1c"
   msg " Supported groups of drivers:"
   msg " atheros <  ath5k ath9k ar9170 zd1211rw >"
   msg " ath <  ath5k ath9k ar9170 >"
   msg " intel <  iwl3945 iwlagn ipw2100 ipw2200 >"
   msg " iwlwifi <  iwl3945 iwlagn >"
   msg " rtl818x <  rtl8180 rtl8187 >"
   msg " wl12xx <  wl1251 (SPI and SDIO) wl1271 >"
   msg2 "Please write the name of your driver or group, if you don't know which ones or want all please type 'all'"
 
  read answer
  
  if [[ "$answer" = "all" ]]; then
     msg "Starting build of all drivers"
  else
  scripts/driver-select $answer || return 1
  msg "Starting build of $answer drivers "
   fi

  ##uncomment if you encounter problems with rt2870 
  sed -i 's/^\# CONFIG_RT2800USB_RT30XX/CONFIG_RT2800USB_RT30XX/' config.mk

  make || return 1
  make INSTALL_MOD_PATH=$pkgdir install-modules || return 1
  install -dm755 $pkgdir/usr/sbin
  install -dm755 $pkgdir/lib/udev/rules.d
  install -dm755 $pkgdir/usr/lib/compat-wireless
  install scripts/madwifi-unload	$pkgdir/usr/sbin/
  install scripts/athenable		$pkgdir/usr/sbin/
  install scripts/b43enable		$pkgdir/usr/sbin/
  install scripts/iwl-enable		$pkgdir/usr/sbin/
  install scripts/athload		$pkgdir/usr/sbin/
  install scripts/b43load		$pkgdir/usr/sbin/
  install scripts/iwl-load		$pkgdir/usr/sbin/
  install udev/compat_firmware.sh	$pkgdir/lib/udev/
  install udev/50-compat_firmware.rules $pkgdir/lib/udev/rules.d/
  install scripts/modlib.sh		$pkgdir/usr/lib/compat-wireless/
  install scripts/check_depmod  	$pkgdir/usr/lib/compat-wireless/
}
